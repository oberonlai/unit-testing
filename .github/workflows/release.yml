name: Test and Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        php-version: ['8.2']
    services:
      database:
        image: mysql:latest
        env:
          MYSQL_DATABASE: wordpress_tests
          MYSQL_ROOT_PASSWORD: root
        ports:
          - 3306:3306
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php-version }}
          tools: phpunit-polyfills:1.1

      - name: Install Subversion
        run: sudo apt-get update && sudo apt-get install -y subversion

      - name: Get Composer cache directory
        id: composer-cache
        run: echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT

      - name: Cache Composer dependencies
        uses: actions/cache@v3
        with:
          path: ${{ steps.composer-cache.outputs.dir }}
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: ${{ runner.os }}-composer-

      - name: Validate composer files
        run: composer validate --strict

      - name: Install dependencies
        run: composer install --prefer-dist --no-progress

      - name: Setup tests
        run: bash bin/install-wp-tests.sh wordpress_tests root root 127.0.0.1 latest true

      - name: Run tests
        run: composer test

  release:
    name: Build and Release
    needs: test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          tools: composer

      - name: Get plugin version
        id: version
        run: |
          # Get version from git tag
          VERSION=${GITHUB_REF#refs/tags/}
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Plugin Version: ${VERSION}"

      - name: Install production dependencies
        run: composer install --no-dev --optimize-autoloader --no-interaction

      - name: Create build directory
        run: |
          mkdir -p build/unit-testing
          
      - name: Copy plugin files
        run: |
          rsync -av \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='.gitignore' \
            --exclude='.phpcs.xml.dist' \
            --exclude='node_modules' \
            --exclude='tests' \
            --exclude='bin' \
            --exclude='build' \
            --exclude='composer.json' \
            --exclude='composer.lock' \
            --exclude='phpunit.xml.dist' \
            --exclude='phpunit.xml' \
            --exclude='*.sh' \
            --exclude='CLAUDE.md' \
            --exclude='.claude' \
            --exclude='.kiro' \
            --exclude='.tinkersan' \
            --exclude='.playwright-mcp' \
            --exclude='scripts' \
            --exclude='.agent' \
            . build/unit-testing/

      - name: Create ZIP file
        run: |
          cd build
          zip -r unit-testing-${{ steps.version.outputs.version }}.zip unit-testing
          cd ..
          
      - name: Generate changelog
        id: changelog
        run: |
          PREVIOUS_TAG=$(git describe --abbrev=0 --tags $(git rev-list --tags --skip=1 --max-count=1) 2>/dev/null || echo "")
          if [ -z "$PREVIOUS_TAG" ]; then
            CHANGELOG=$(git log --pretty=format:"- %s" --no-merges)
          else
            CHANGELOG=$(git log ${PREVIOUS_TAG}..HEAD --pretty=format:"- %s" --no-merges)
          fi
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: Release ${{ steps.version.outputs.version }}
          body: |
            ## ðŸŽ‰ Version ${{ steps.version.outputs.version }}
            
            ### ðŸ“ Changes
            ${{ steps.changelog.outputs.changelog }}
            
            ### ðŸ“¦ Installation
            1. Download `unit-testing-${{ steps.version.outputs.version }}.zip` below
            2. Go to WordPress Admin > Plugins > Add New > Upload Plugin
            3. Select the downloaded ZIP file and install
            4. Activate the plugin
            
            ### âœ… Included Dependencies
            - Production dependencies only (no dev tools)
          files: |
            build/unit-testing-${{ steps.version.outputs.version }}.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
